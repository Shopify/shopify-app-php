name: Close External PRs

on:
  pull_request_target:
    types: [opened, reopened]

permissions:
  pull-requests: write

jobs:
  close-external-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR author is from Shopify
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            const association = context.payload.pull_request.author_association;

            // author_association is unreliable when org membership is private
            // (returns CONTRIBUTOR instead of MEMBER), so also check the
            // repo permission level which works regardless of visibility
            const trustedAssociations = ['MEMBER', 'OWNER', 'COLLABORATOR'];
            let isTrusted = trustedAssociations.includes(association);

            if (!isTrusted) {
              try {
                const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  username: author,
                });
                isTrusted = ['write', 'admin'].includes(data.permission);
                console.log(`${author} repo permission: ${data.permission}`);
              } catch (error) {
                console.log(`Permission check failed for ${author}: ${error.message}`);
              }
            }

            console.log(`${author} author_association: ${association}, trusted: ${isTrusted}`);
            core.setOutput('is-shopify', isTrusted ? 'true' : 'false');

      - name: Close PR and comment
        if: steps.check-author.outputs.is-shopify == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Add comment to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Thanks for your interest. This repository does not accept contributions, so we've closed this PR.

              To report a bug, request a feature, or share feedback, please post in the [Shopify dev community forums](https://community.shopify.dev/new-topic?title=[Feedback%20for%20php%20package]&category=shopify-cli-libraries&tags=php-library&domain=PHP%20Library)

              We triage in the forums, not in this repo. PRs and issues here are closed without review.

              For more details see [CONTRIBUTING.md](https://github.com/Shopify/shopify-app-php/blob/main/CONTRIBUTING.md).`
            });

            // Close the PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              state: 'closed'
            });

            console.log(`Closed PR #${prNumber} from external contributor`);
